## WARNING - takes a long time to build and run. Only run with `docker compose`

FROM alpine:latest as client-builder

WORKDIR /client
COPY . .

# Variables
ENV GODOT_VERSION "3.5.1"

# Updates and installs
RUN apk update && apk add --no-cache bash wget git

# Godot and export template directories
RUN mkdir ~/.cache
RUN mkdir -p ~/.config/godot
RUN mkdir -p ~/.local/share/godot/templates/${GODOT_VERSION}.stable

# Required to run Godot
RUN wget -q https://github.com/sgerrand/alpine-pkg-glibc/releases/download/2.31-r0/glibc-2.31-r0.apk
RUN apk add --allow-untrusted --force-overwrite glibc-2.31-r0.apk

WORKDIR /client/_engine

RUN wget -q https://downloads.tuxfamily.org/godotengine/${GODOT_VERSION}/Godot_v${GODOT_VERSION}-stable_linux_headless.64.zip
RUN wget -q https://downloads.tuxfamily.org/godotengine/${GODOT_VERSION}/Godot_v${GODOT_VERSION}-stable_export_templates.tpz

RUN unzip Godot_v${GODOT_VERSION}-stable_export_templates.tpz
RUN unzip Godot_v${GODOT_VERSION}-stable_linux_headless.64.zip

RUN mv Godot_v${GODOT_VERSION}-stable_linux_headless.64 /usr/local/bin/godot
RUN mv templates/* ~/.local/share/godot/templates/${GODOT_VERSION}.stable

WORKDIR /client

# Make directory to run the app from
RUN mkdir -p dist
RUN godot --path . --export "HTML5" dist/index.html


FROM busybox:1.35

WORKDIR /home/static

COPY --from=client-builder /client/dist/* /home/static/

EXPOSE 3000
CMD ["busybox", "httpd", "-f", "-v", "-p", "3000"]
