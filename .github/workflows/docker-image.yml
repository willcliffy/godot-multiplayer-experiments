name: Build and deploy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Docker Login
      if: success()
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and Push Docker Image
      if: success()
      run: |
        docker build server/ --file ./server/Dockerfile -t willcliffy/kilnwood:$GITHUB_SHA -t willcliffy/kilnwood:latest -t willcliffy/kilnwood:dev
        docker push willcliffy/kilnwood:$GITHUB_SHA
        docker push willcliffy/kilnwood:dev
        docker push willcliffy/kilnwood:latest
    - name: Install helm
      if: success()
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
    - name: Deploy
      if: success()
      env:
        GCLOUD_KEY: ${{ secrets.GCLOUD_KEY }}
      run: |
        echo "$GCLOUD_KEY" | base64 --decode > ${HOME}/gcloud.json
        gcloud auth activate-service-account --key-file=${HOME}/gcloud.json
        gcloud auth configure-docker
        gcloud container clusters get-credentials kilnwood-na --zone us-east5-c --project kilnwood
        helm upgrade --install kilnwood ./infra -f ./infra/values/dev.yaml --wait
