name: Build and deploy
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: 1.18.x
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --tests=false
          working-directory: server
  build:
    runs-on: ubuntu-latest
    needs: lint
    steps:
    - uses: actions/checkout@v3
    - name: Docker Login
      if: success()
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Build and Push Docker Image
      if: success()
      run: |
        docker build server/ --file ./server/Dockerfile -t willcliffy/kilnwood:$GITHUB_SHA -t willcliffy/kilnwood:latest -t willcliffy/kilnwood:dev
        docker push willcliffy/kilnwood:$GITHUB_SHA
        docker push willcliffy/kilnwood:dev
        docker push willcliffy/kilnwood:latest
  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
    - uses: actions/checkout@v3
    - name: Install Helm
      if: success()
      run: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
    - name: Deploy
      if: success()
      run: |
        echo "${{ secrets.KILNWOOD_NA_KUBECONFIG }}" >> ~/.kube/config
        helm upgrade --install kilnwood ./infra -f ./infra/values/dev.yaml --set gameserver.deploy.tag=$GITHUB_SHA --wait

